# Claude Code Project Notes

## Cross-Project Reference

**IMPORTANT**: Always check The Story Hub (TSH) for programming tips and patterns:
- **The Story Hub**: `/home/liqk1ugzoezh5okwywlr_/dev/the-story-hub/`
- Check TSH's CLAUDE.md for: AppSync resolver patterns, AWS infrastructure, authentication flows

## Code Generation

- Types in `shared/src/types/gqlTypes.ts` are automatically generated by codegen
- Do NOT manually edit `gqlTypes.ts` - changes will be overwritten
- To add new types, update the GraphQL schema and run codegen

## AppSync Resolvers

This project uses APPSYNC_JS (TypeScript) resolvers:
- Resolver files: `backend/resolvers/<domain>/<type>/<Type>.<operationName>.ts`
- CloudFormation config: `deploy/resources/AppSync/appsync.yaml`
- Resolver compiler: `deploy/utils/resolver-compiler.ts`

### AppSync JavaScript Runtime Restrictions

AppSync resolvers run in a restricted JavaScript environment. Follow these conventions strictly:

**REQUIRED PATTERNS:**

- **Imports**: Must import `{ util, Context }` from `"@aws-appsync/utils"`
- **IDs**: Use `util.autoId()` - NOT `uuid` or other libraries
- **Timestamps**: Use `util.time.nowISO8601()` - NOT `new Date().toISOString()`
- **DynamoDB**: Use `util.dynamodb.toMapValues()` for converting objects
- **Errors**: Use `return util.error(message, type)` - MUST include `return` keyword

**ALLOWED JAVASCRIPT:**

- Template literals, arrow functions (only at module level), spread operators
- Object/array manipulation
- `for...of` loops, `for...in` loops
- console.log() for logging
- Nullish coalescing (`??`) and optional chaining (`?.`)

**NOT ALLOWED:**

- `new Date()` - causes deployment failure (use `util.time.nowISO8601()`)
- `Date.now()` - causes deployment failure (use `util.time.nowEpochMilliSeconds()`)
- `String()` constructor - causes deployment failure (use template literal: `` `${value}` ``)
- External npm packages (uuid, etc.)
- Node.js built-in modules (fs, path, crypto, etc.)
- **`while` loops** - causes "@aws-appsync/no-while" error
- **`do...while` loops** - not supported
- **ALL traditional `for` loops** - causes "@aws-appsync/no-for" error
  - `for (let i = 0; i < arr.length; i++)` - NOT ALLOWED
  - `for...of` and `for...in` ARE allowed
- **Inline functions in array methods** - causes "Unsupported Syntax Type"
  - `arr.sort((a, b) => a - b)` - NOT ALLOWED
  - `arr.map((x) => x.name)` - NOT ALLOWED
  - `arr.filter((x) => x.active)` - NOT ALLOWED
  - Use `for (const item of arr)` loops instead
- **`continue` statements** - causes "continue statements are not supported"
  - Use positive condition: `if (item) { ... }` instead of `if (!item) continue;`

**CRITICAL: `util.error()` Must Be Called at Top Level**

- `util.error()` MUST be called at the top level of `request()` or `response()` functions
- **NEVER call `util.error()` inside helper/utility functions** - AppSync rejects this pattern

## Deployment Rules

**IMPORTANT**: Do NOT run deployments unless explicitly asked by the user.

- Don't run `yarn workspace @quiz/deploy deploy:dev` or `deploy:prod` without explicit request
- Building the frontend (`yarn build`) is fine without explicit permission
- Compiling/validating resolvers is fine, but don't deploy to AWS

## Logging

Deploy logs should be written to `~/dev/quiz-app/.cache/logs/` directory.
